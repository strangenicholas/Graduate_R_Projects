library(dplyr) 
library(haven)
library(ggplot2) 
library(caret) 
library(pROC) 
library(randomForest)


# Construct the average Industry concentration and Profit margins (PMs) for the firms
# in all three-digit industries each year SIC3 YEAR (note that you need to construct the
# variable SIC3 by taking the first three digits of an SIC code). PMs are defined above. By
# averaging the PMs, weight with SLS.
# Define Industry concentration as the fraction of sales generated by the 5 largest firms in
# the industry each year relative to the total amount of sales generated by all firms in the
# industry that year. More specifically:
# 1. Sort all firms based on their sales (SLS) in a descending order by SIC3 YEAR.
# 2. Identify the 5 largest firms in terms of SLS (if there are less than 5 years, identify all of
# them).
# 3. Construct

## Read in data
cmpst <-
  read_sas("C:/Users/nicho/OneDrive/UCF MS - FinTech/FIN 6779/compst7018.sas7bdat")
as.data.frame(cmpst)

# head(cmpst)
# summary(cmpst) 

# Replace some negative values with missing 
cmpst <- 
  cmpst %>% 
  mutate(CA = replace(CA, CA <= 0, NA), 
         INTAN = replace(INTAN, INTAN <= 0, NA), 
         INVT = replace(INVT, INVT <= 0, NA), 
         SLS = replace(SLS, SLS <= 0, NA), 
         CASH = replace(CASH, CASH <= 0, NA), 
         INTXP = replace(INTXP, INTXP <= 0, NA), 
         DIV = replace(DIV, DIV <= 0, NA), 
         RD = replace(RD, RD <= 0, 0), 
         CAPEX = replace(CAPEX, CAPEX <= 0, NA), 
         BVA = replace(BVA, BVA <= 0, NA), 
         BVE = replace(BVE, BVE <= 0, NA),    
         TLIAB = replace(TLIAB, TLIAB <= 0, NA)) 

# Filter the data and construct ratios 
cmpst <- 
  cmpst %>% 
  arrange(PERMNO, year) %>% 
  mutate(CHECK = BVA-TLIAB-BVE) %>%  
  filter(CHECK > -0.1 & CHECK < 0.1) %>% 
  mutate(ROA=NI/BVA, 
         RD = if_else(is.na(RD), 0, RD), 
         RDA=RD/BVA, RDIND=sign(RD),  
         SIC3CHAR=substr(SIC, 1, 3), SIC3=as.numeric(SIC3CHAR),
         PM = NI/SLS) %>% 
  select(PERMNO, cname, year, SIC, SIC3, FYR, ROA, NI, BVA, SLS, 
         RD, RDA, RDIND, PM) 

# head(cmpst)
# summary(cmpst) 


## Winsorize ratios 
library(statar) 
cmpst <- 
  cmpst %>% 
  mutate(ROA=winsorize(ROA, probs = c(0.01, 0.99)), 
         RDA=winsorize(RDA, probs = c(0.01, 0.99)))

head(cmpst)
# summary(cmpst)


# View(cmpst)

# Get top 5 firm concentration

top5_sales <- cmpst %>%
  group_by(SIC3, year) %>%
  arrange(desc(SLS)) %>%
  slice_head(n = 5) %>%
  summarise(sum_of_top5_SLS = sum(SLS))
  

totalSLS <- cmpst %>%
  group_by(SIC3, year) %>%
  summarise(total_SLS = sum(SLS) , PMW = weighted.mean(PM, SLS, na.rm = TRUE)) 

combined_table <- left_join(top5_sales, totalSLS, by = c("SIC3", "year")) %>%
  mutate(IC = sum_of_top5_SLS / total_SLS)
# select(year, SIC3, IC, PM)


head(combined_table)

# Correlation of IC & PM

corr_alltime <-
  cor(combined_table$IC, combined_table$PMW, use = "complete.obs")

corr_alltime

corr_over_time <- combined_table %>%
  group_by(year) %>%
  summarise(cor_over_time = cor(IC, PMW, use = "complete.obs"))

corr_over_time


# Visualize All Time
plot(combined_table$IC, combined_table$PMW,
     xlab = "IC", ylab = "PMW",
     main = "Scatterplot of IC vs PMW")

# Add regression line
abline(lm(combined_table$PMW ~ combined_table$IC), col = "red")

# Print cc
text(x = max(combined_table$IC), y = max(combined_table$PMW),
     labels = paste("Correlation =", round(corr_alltime, 2)), pos = 1)

# Visualize overtime
ggplot(corr_over_time, aes(x = year, y = cor_over_time)) +
  geom_line() +
  geom_point() +
  labs(title = "Correlation Over Time",
       x = "Year",
       y = "Correlation (IC vs PMW)")




